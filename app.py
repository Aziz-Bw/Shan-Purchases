import streamlit as st
import pandas as pd
import os
from datetime import datetime

# --- ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ---
st.set_page_config(page_title="ูุธุงู ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช", layout="wide", page_icon="๐ข")

# ุชูุนูู ุงููุงุฌูุฉ ุงูุนุฑุจูุฉ (RTL)
st.markdown("""
<style>
    .main {direction: rtl;}
    h1, h2, h3, p, div {text-align: right;}
    .stMetric {text-align: right !important;}
    /* ุชูุณูู ุงูุฌุฏุงูู ูุชุธูุฑ ูู ุงููููู ูููุณุงุฑ */
    .stDataFrame {direction: rtl;}
</style>
""", unsafe_allow_html=True)

# --- ุงุณู ููู ุงูุจูุงูุงุช ---
FILE_PATH = 'data.xlsx'

# --- ุฏุงูุฉ ุชุญููู ููุนุงูุฌุฉ ุงูุจูุงูุงุช ---
def load_data():
    if not os.path.exists(FILE_PATH):
        # ุฅูุดุงุก ููู ุฌุฏูุฏ ุฅุฐุง ูู ููู ููุฌูุฏุงู
        df = pd.DataFrame(columns=[
            'ุงุณู ุงูุทูุจูุฉ', 'ุงุณู ุงูููุฑุฏ', 'ูููุฉ ($)', 'ุณุนุฑ ุงูุตุฑู', 
            'ุฅุฌูุงูู_ุงูุชูููุฉ', 'ุงููุฏููุน', 'ุงููุชุจูู', 
            'ุงุนุชูุงุฏ %', 'ุดุญู %', 'ูุตูู %', 
            'ุชุงุฑูุฎ ุงููุตูู ุงููุณุชูุฏู', 'ุงูุญุงูุฉ', 'ููุงุญุธุงุช'
        ])
        df.to_excel(FILE_PATH, index=False)
        return df

    try:
        df = pd.read_excel(FILE_PATH)
        
        # 1. ุชุตุญูุญ ุฃุณูุงุก ุงูุฃุนูุฏุฉ (ูุดููุฉ ุงูููุฒุฉ)
        # ูุบูุฑ ุฃู ุนููุฏ ุงุณูู "ุงุฌูุงูู..." ููุตุจุญ "ุฅุฌูุงูู..."
        df.rename(columns=lambda x: x.replace('ุงุฌูุงูู', 'ุฅุฌูุงูู'), inplace=True)

        # 2. ุงูุชุฃูุฏ ูู ุฃู ุงูุฃุนูุฏุฉ ุงูุฑูููุฉ ูู ุฃุฑูุงู ูุนููุฉ
        numeric_cols = ['ูููุฉ ($)', 'ุณุนุฑ ุงูุตุฑู', 'ุฅุฌูุงูู_ุงูุชูููุฉ', 'ุงููุฏููุน', 'ุงููุชุจูู']
        for col in numeric_cols:
            if col in df.columns:
                df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)
            else:
                df[col] = 0.0 # ุฅูุดุงุก ุงูุนููุฏ ุฅุฐุง ูุงู ูุงูุตุงู

        # 3. ุฅุนุงุฏุฉ ุญุณุงุจ ุงูููู (Fix Calculations)
        # ุญุณุงุจ ุงูุฅุฌูุงูู: ุงููููุฉ * ุณุนุฑ ุงูุตุฑู
        df['ุฅุฌูุงูู_ุงูุชูููุฉ'] = df['ูููุฉ ($)'] * df['ุณุนุฑ ุงูุตุฑู']
        
        # ุญุณุงุจ ุงููุชุจูู: ุงูุฅุฌูุงูู - ุงููุฏููุน
        df['ุงููุชุจูู'] = df['ุฅุฌูุงูู_ุงูุชูููุฉ'] - df['ุงููุฏููุน']

        return df
    except Exception as e:
        st.error(f"ุญุฏุซ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: {e}")
        return pd.DataFrame()

# --- ุชุญููู ุงูุจูุงูุงุช ---
df = load_data()

# --- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (ุชุณุฌูู ุทูุจูุฉ) ---
with st.sidebar:
    st.header("๐ ุชุณุฌูู ุทูุจูุฉ ุฌุฏูุฏุฉ")
    
    order_name = st.text_input("ุงุณู ุงูุทูุจูุฉ")
    supplier_name = st.text_input("ุงุณู ุงูููุฑุฏ")
    
    col1, col2 = st.columns(2)
    with col1:
        val_usd = st.number_input("ูููุฉ ($)", min_value=0.0, format="%.2f")
    with col2:
        ex_rate = st.number_input("ุณุนุฑ ุงูุตุฑู", value=3.75, min_value=0.0, format="%.2f")
        
    st.markdown(f"**ุงูุฅุฌูุงูู: {val_usd * ex_rate:,.2f} ุฑูุงู**")
    
    # ูุฏุฎูุงุช ุงููุณุจ
    c1, c2, c3 = st.columns(3)
    with c1: credit_pct = st.number_input("ุงุนุชูุงุฏ %", 0, 100, 50)
    with c2: ship_pct = st.number_input("ุดุญู %", 0, 100, 20)
    with c3: arrival_pct = st.number_input("ูุตูู %", 0, 100, 30)
    
    # ุงููุฏููุน ูุนููุงู (ููููู ุชุนุฏููู ููููู ุญุณุจ ุงููุนุงุฏูุฉ ุฃู ูุฏูู)
    # ููุง ุณุฃูุชุฑุถ ุฃู ุงููุฏููุน ุญุงููุงู ูู 0 ุนูุฏ ูุชุญ ุงูุทูุจุ ุฃู ููููู ูุถุน ุญูู ุฅุฏุฎุงู ูู
    paid_amount = st.number_input("ุงููุจูุบ ุงููุฏููุน (ููุฏู)", min_value=0.0, format="%.2f")

    target_date = st.date_input("ุชุงุฑูุฎ ุงููุตูู ุงููุณุชูุฏู")
    status = st.selectbox("ุงูุญุงูุฉ ุงูุฃูููุฉ", ["ูู ูุจุฏุฃ", "ุฌุงุฑู ุงูุชุตููุน", "ูู ุงูุดุญู", "ูุตูุช"])
    notes = st.text_area("ููุงุญุธุงุช")
    
    if st.button("๐พ ุญูุธ ุงูุทูุจูุฉ"):
        if order_name:
            # ุงูุญุณุงุจุงุช ูุจู ุงูุญูุธ
            total_sar = val_usd * ex_rate
            remaining = total_sar - paid_amount
            
            new_row = {
                'ุงุณู ุงูุทูุจูุฉ': order_name,
                'ุงุณู ุงูููุฑุฏ': supplier_name,
                'ูููุฉ ($)': val_usd,
                'ุณุนุฑ ุงูุตุฑู': ex_rate,
                'ุฅุฌูุงูู_ุงูุชูููุฉ': total_sar,
                'ุงููุฏููุน': paid_amount,
                'ุงููุชุจูู': remaining,
                'ุงุนุชูุงุฏ %': credit_pct,
                'ุดุญู %': ship_pct,
                'ูุตูู %': arrival_pct,
                'ุชุงุฑูุฎ ุงููุตูู ุงููุณุชูุฏู': target_date,
                'ุงูุญุงูุฉ': status,
                'ููุงุญุธุงุช': notes
            }
            
            # ุฅุถุงูุฉ ุงูุตู ุงูุฌุฏูุฏ ูุญูุธ ุงูููู
            df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)
            df.to_excel(FILE_PATH, index=False)
            st.success("ุชู ุงูุญูุธ ุจูุฌุงุญ! ุณูุชู ุชุญุฏูุซ ุงูุตูุญุฉ...")
            st.rerun() # ุชุญุฏูุซ ุงูุตูุญุฉ ููุฑุงู
        else:
            st.warning("ูุฑุฌู ูุชุงุจุฉ ุงุณู ุงูุทูุจูุฉ ุนูู ุงูุฃูู")

# --- ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ (ุงูุฏุงุดุจูุฑุฏ) ---
st.title("๐ข ูุธุงู ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช (ุณุฌู ุงูุฏูุนุงุช)")

# ุญุณุงุจุงุช ุงูุจุทุงูุงุช ุงูุนูููุฉ
total_liability = df['ุฅุฌูุงูู_ุงูุชูููุฉ'].sum()
total_paid = df['ุงููุฏููุน'].sum()
total_remaining = df['ุงููุชุจูู'].sum()
goods_on_way = df[df['ุงูุญุงูุฉ'] == 'ูู ุงูุดุญู']['ุฅุฌูุงูู_ุงูุชูููุฉ'].sum() # ูุซุงู

# ุนุฑุถ ุงูุจุทุงูุงุช (Metrics)
m1, m2, m3, m4 = st.columns(4)
with m4: st.metric("ุฅุฌูุงูู ุงูุงูุชุฒุงู", f"{total_liability:,.0f}")
with m3: st.metric("ุงููุฏููุน", f"{total_paid:,.0f}")
with m2: st.metric("ุงููุชุจูู", f"{total_remaining:,.0f}")
with m1: st.metric("ุจุถุงุนุฉ ุจุงูุทุฑูู", f"{goods_on_way:,.0f}")

st.divider()

# --- ุงูุฌุฏูู ุงูุชูุตููู ---
st.subheader("๐ ุณุฌู ุงูุจูุงูุงุช ุงูุชูุตููู")
st.dataframe(
    df.style.format({
        'ูููุฉ ($)': '{:,.2f}',
        'ุฅุฌูุงูู_ุงูุชูููุฉ': '{:,.2f}',
        'ุงููุฏููุน': '{:,.2f}',
        'ุงููุชุจูู': '{:,.2f}'
    }), 
    use_container_width=True
)

# ุฒุฑ ุจุณูุท ูุชุญุฏูุซ ุงูุจูุงูุงุช ูุฏููุงู ุฅุฐุง ูุฒู ุงูุฃูุฑ
if st.button("ุชุญุฏูุซ ุงูุจูุงูุงุช ๐"):
    st.rerun()
